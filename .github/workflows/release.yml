name: Multi-Browser Extension Build and Package

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a new release'
        required: false
        default: 'false'

jobs:
  build-and-package:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run tests with coverage
      run: npm run test:coverage
      
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
      
    - name: Make build script executable
      run: chmod +x scripts/build-multi-browser.sh
      
    - name: Get extension version
      id: version
      run: |
        VERSION=$(node -e "console.log(require('./manifest.json').version)")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Extension version: $VERSION"
        
    - name: Build multi-browser packages
      run: |
        echo "ðŸ“¦ Building packages for all browsers..."
        npm run build
        
    - name: List build artifacts
      run: |
        echo "ðŸ“ Build artifacts:"
        ls -la dist/
        echo ""
        echo "ðŸ” Checksums:"
        cat dist/checksums.txt
        
    - name: Upload Chrome/Edge package as artifact
      uses: actions/upload-artifact@v4
      with:
        name: chrome-edge-extension-v${{ steps.version.outputs.version }}
        path: |
          dist/ai-text-proofreader-chrome-edge-v${{ steps.version.outputs.version }}.zip
          dist/checksums.txt
          
    - name: Upload Firefox package as artifact
      uses: actions/upload-artifact@v4
      with:
        name: firefox-extension-v${{ steps.version.outputs.version }}
        path: |
          dist/ai-text-proofreader-firefox-v${{ steps.version.outputs.version }}.zip
          dist/checksums.txt
          
    - name: Upload Chrome/Edge package to release
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: dist/ai-text-proofreader-chrome-edge-v${{ steps.version.outputs.version }}.zip
        asset_name: ai-text-proofreader-chrome-edge-v${{ steps.version.outputs.version }}.zip
        asset_content_type: application/zip
        
    - name: Upload Firefox package to release
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: dist/ai-text-proofreader-firefox-v${{ steps.version.outputs.version }}.zip
        asset_name: ai-text-proofreader-firefox-v${{ steps.version.outputs.version }}.zip
        asset_content_type: application/zip
        
    - name: Upload checksums to release
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: dist/checksums.txt
        asset_name: checksums.txt
        asset_content_type: text/plain
        
    - name: Generate multi-browser installation instructions
      run: |
        cat > INSTALLATION.md << 'EOF'
        # AI Text Proofreader v${{ steps.version.outputs.version }} - Multi-Browser Installation Guide
        
        This extension is now available for **Chrome**, **Edge**, and **Firefox**!
        
        ## ðŸŒ Browser Support
        
        - âœ… **Chrome** - Full support (Manifest V3)
        - âœ… **Edge** - Full support (Manifest V3) 
        - âœ… **Firefox** - Full support (Manifest V2)
        
        ## ðŸ“¦ Downloads
        
        Choose the package for your browser:
        
        - **Chrome/Edge**: `ai-text-proofreader-chrome-edge-v${{ steps.version.outputs.version }}.zip`
        - **Firefox**: `ai-text-proofreader-firefox-v${{ steps.version.outputs.version }}.zip`
        
        ## ðŸ”§ Installation Instructions
        
        ### Chrome/Edge Installation
        
        1. Download the `ai-text-proofreader-chrome-edge-v${{ steps.version.outputs.version }}.zip` file
        2. Extract the ZIP file to a folder on your computer
        3. Open Chrome/Edge and go to:
           - Chrome: `chrome://extensions/`
           - Edge: `edge://extensions/`
        4. Enable "Developer mode" (toggle in top-right corner)
        5. Click "Load unpacked" and select the extracted folder
        6. The extension should now appear in your extensions list
        
        ### Firefox Installation
        
        #### Temporary Installation (for testing)
        1. Download the `ai-text-proofreader-firefox-v${{ steps.version.outputs.version }}.zip` file
        2. Extract the ZIP file to a folder on your computer
        3. Open Firefox and go to `about:debugging`
        4. Click "This Firefox"
        5. Click "Load Temporary Add-on"
        6. Select the `manifest.json` file from the extracted folder
        
        #### Permanent Installation
        For permanent installation in Firefox, the extension needs to be signed by Mozilla. This is currently in development.
        
        ## âœ¨ Features
        
        - ðŸ¤– **AI-powered text proofreading** and correction
        - ðŸŽ¯ **Context-aware suggestions** (Email, GitHub, Social Media, etc.)
        - ðŸ”§ **Customizable settings** and prompts
        - ðŸŒ **Multi-provider support**: Local (Ollama) and cloud (OpenAI) LLMs
        - ðŸ“ **Formatting preservation** (newlines, bullets, code blocks)
        - ðŸ”’ **Privacy-focused** with local LLM support
        - ðŸŒ **Cross-browser compatibility** (Chrome, Edge, Firefox)
        
        ## âš™ï¸ Configuration
        
        1. Click the extension icon in your browser toolbar
        2. Go to **Settings** tab to configure your AI provider
        3. Go to **Context** tab to customize website categories and prompts
        
        ## ðŸš€ Supported AI Providers
        
        - **Ollama (Local)**: Run AI models locally for maximum privacy
        - **OpenAI**: Use GPT models via API key
        - **Custom Endpoint**: Connect to your own AI service
        
        ## ðŸ” Security & Privacy
        
        - **Local processing**: Use Ollama for complete privacy
        - **No data collection**: Your text never leaves your computer with local models
        - **Secure API calls**: Cloud providers use encrypted connections
        
        ## ðŸ” Verification
        
        **SHA256 Checksums**: See `checksums.txt` file
        
        Verify download integrity by checking the SHA256 hash matches the provided checksum.
        
        ## ðŸ†˜ Support
        
        For issues, questions, or feature requests, please visit the GitHub repository:
        https://github.com/tactmaster/ai-text-proofreader-extension
        
        ---
        
        **Multi-Browser Extension** | **v${{ steps.version.outputs.version }}** | **Built with â¤ï¸ for Chrome, Edge & Firefox**
        EOF
        
    - name: Upload installation instructions to release
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: INSTALLATION.md
        asset_name: INSTALLATION.md
        asset_content_type: text/markdown
        
    - name: Generate installation instructions
      run: |
        cat > INSTALLATION.md << 'EOF'
        # AI Text Proofreader v${{ steps.version.outputs.version }} - Installation Guide
        
        ## Chrome/Edge Installation (Developer Mode)
        
        1. Download the `ai-text-proofreader-v${{ steps.version.outputs.version }}.zip` file
        2. Extract the ZIP file to a folder on your computer
        3. Open Chrome/Edge and go to `chrome://extensions/` or `edge://extensions/`
        4. Enable "Developer mode" (toggle in top-right corner)
        5. Click "Load unpacked" and select the extracted folder
        6. The extension should now appear in your extensions list
        
        ## Features
        
        - ðŸ¤– AI-powered text proofreading and correction
        - ðŸŽ¯ Context-aware suggestions (Email, GitHub, etc.)
        - ðŸ”§ Customizable settings and prompts
        - ðŸŒ Support for local (Ollama) and cloud (OpenAI) LLMs
        - ðŸ“ Preserves formatting (newlines, bullets, code blocks)
        
        ## Configuration
        
        1. Click the extension icon in your browser toolbar
        2. Go to Settings tab to configure your AI provider
        3. Go to Context tab to customize website categories and prompts
        
        ## Supported AI Providers
        
        - **Ollama (Local)**: Run AI models locally for privacy
        - **OpenAI**: Use GPT models via API key
        - **Custom Endpoint**: Connect to your own AI service
        
        ## Verification
        
        **SHA256 Checksum**: See checksums.txt file
        
        Verify the download integrity by checking the SHA256 hash matches the provided checksum.
        
        ---
        
        **Support**: For issues or questions, please visit the GitHub repository.
        EOF
        
    - name: Upload installation instructions
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: INSTALLATION.md
        asset_name: INSTALLATION.md
        asset_content_type: text/markdown
